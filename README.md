[![Quality&Tests](https://github.com/vol1ura/parkrun_bot/actions/workflows/python-app.yml/badge.svg)](https://github.com/vol1ura/parkrun_bot/actions/workflows/python-app.yml)
[![codecov](https://codecov.io/gh/vol1ura/parkrun_bot/branch/master/graph/badge.svg?token=HFV9PFM5UL)](https://codecov.io/gh/vol1ura/parkrun_bot)
[![Code Style](https://img.shields.io/badge/Code%20Style-PEP%208-blueviolet)](https://www.python.org/dev/peps/pep-0008/)
![GitHub last commit](https://img.shields.io/github/last-commit/vol1ura/parkrun_bot)
![GitHub commit activity](https://img.shields.io/github/commit-activity/m/vol1ura/parkrun_bot)

# Parkrun Bot

–¢–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ parkrun, –≤–∫–ª—é—á–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é, –ø–æ–ª—É—á–µ–Ω–∏–µ QR-–∫–æ–¥–æ–≤ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üèÉ‚Äç‚ôÇÔ∏è –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ S95
- üì± –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ QR-–∫–æ–¥–∞
- üìä –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–∏—á–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–±–µ–≥–æ–≤
- üèÜ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–±–µ–≥–∞ –∏ –∫–ª—É–±–∞
- üìû –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
- üñº –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å VK –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.10+
- PostgreSQL
- Docker (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

–í –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ `--SENSITIVE--`:

1. –¢–æ–∫–µ–Ω—ã –∏ –∫–ª—é—á–∏:
   - API_BOT_TOKEN
   - INTERNAL_API_KEY
   - ROLLBAR_TOKEN
   - WEBHOOK

2. –î–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:
   - DATABASE_URL
   - REDIS_URL
   - HOST
   - SMTP_SERVER

3. –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
   - EMAIL_ADDRESS
   - EMAIL_PASSWORD
   - POSTGRES_USER
   - POSTGRES_PASSWORD

4. –î—Ä—É–≥–∏–µ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
   - EMAIL_SENDER

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –õ–æ–∫–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞

1. –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:
```bash
git clone <repository-url>
cd parkrun_bot
```

2. –°–æ–∑–¥–∞–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –µ–≥–æ:
```bash
python -m venv venv
source venv/bin/activate  # –¥–ª—è Linux/Mac
venv\Scripts\activate     # –¥–ª—è Windows
```

3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
pip install -r requirements.txt
```

4. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –Ω–∞ –æ—Å–Ω–æ–≤–µ `.env.example` –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
cp .env.example .env
```

### Docker —É—Å—Ç–∞–Ω–æ–≤–∫–∞

1. –°–æ–±–µ—Ä–∏—Ç–µ –æ–±—Ä–∞–∑:
```bash
docker-compose build
```

2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:
```bash
docker-compose up -d
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ñ–∞–π–ª–µ `config.py`. –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏:

```env
API_BOT_TOKEN=your_telegram_bot_token
VK_SERVICE_TOKEN=your_vk_service_token
DATABASE_URL=postgresql://user:password@localhost:5432/dbname
PRODUCTION_ENV=False
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
parkrun_bot/
‚îú‚îÄ‚îÄ app.py              # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ main.py            # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ config.py          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ handlers/          # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
‚îú‚îÄ‚îÄ utils/            # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îú‚îÄ‚îÄ s95/              # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å S95
‚îú‚îÄ‚îÄ tests/            # –¢–µ—Å—Ç—ã
‚îî‚îÄ‚îÄ deploy/           # –§–∞–π–ª—ã –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
```

## –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

- `/start` - –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º
- `/qrcode` - –ü–æ–ª—É—á–∏—Ç—å QR-–∫–æ–¥ –¥–ª—è S95
- `/register` - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ
- `/statistics` - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–∏—á–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
- `/help` - –ü–æ–ª—É—á–∏—Ç—å —Å–ø—Ä–∞–≤–∫—É
- `/phone` - –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- `/club` - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–ª—É–±
- `/home` - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ–º–∞—à–Ω–∏–π –∑–∞–±–µ–≥
- `/reset` - –û—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ

## –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
python -m pytest tests/
```

### –õ–∏–Ω—Ç–∏–Ω–≥

```bash
make lint
```

### –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞

```bash
make format
```

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –ò—Å–ø–æ–ª—å–∑—É—è Docker

1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ `docker-compose.yml`
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ:
```bash
docker-compose up -d
```

### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ

1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ systemd —Å–µ—Ä–≤–∏—Å (–ø—Ä–∏–º–µ—Ä –≤ `deploy/parkrun_bot.service`)
2. –í–∫–ª—é—á–∏—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å:
```bash
sudo systemctl enable parkrun_bot
sudo systemctl start parkrun_bot
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- –õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `bot.log`
- –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω —Ä–µ–∂–∏–º–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è webhook
- –î–æ—Å—Ç—É–ø–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ HTTP —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤:
- –ú–æ–¥—É–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è API
- –¢–µ—Å—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- –ú–æ–∫–∏ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (VK, S95)

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞.

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- `PRODUCTION` - —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã (true/false)
- `VERSION` - –≤–µ—Ä—Å–∏—è –±–æ—Ç–∞

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞
- `API_BOT_TOKEN` - —Ç–æ–∫–µ–Ω Telegram –±–æ—Ç–∞
- `WEBHOOK` - –ø—É—Ç—å –¥–ª—è webhook
- `HOST` - —Ö–æ—Å—Ç –¥–ª—è webhook
- `PORT` - –ø–æ—Ä—Ç –¥–ª—è webhook

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- `DATABASE_URL` - URL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL
- `DB_MIN_SIZE` - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- `DB_MAX_SIZE` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- `DB_COMMAND_TIMEOUT` - —Ç–∞–π–º–∞—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ (—Å–µ–∫)
- `DB_MAX_QUERIES` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
- `DB_MAX_INACTIVE_TIME` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (—Å–µ–∫)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Redis
- `REDIS_URL` - URL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis
- `REDIS_ENCODING` - –∫–æ–¥–∏—Ä–æ–≤–∫–∞
- `REDIS_DECODE_RESPONSES` - –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ rate limiting
- `RATE_LIMIT` - –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
- `RATE_WINDOW` - –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ (—Å–µ–∫)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- `CACHE_TTL` - –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫—ç—à–∞ (—Å–µ–∫)
- `CACHE_PREFIX` - –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –∫–ª—é—á–µ–π –∫—ç—à–∞

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API
- `INTERNAL_API_KEY` - –∫–ª—é—á –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ API
- `INTERNAL_API_URL` - URL –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ API
- `API_TIMEOUT` - —Ç–∞–π–º–∞—É—Ç –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤ (—Å–µ–∫)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- `ROLLBAR_TOKEN` - —Ç–æ–∫–µ–Ω –¥–ª—è Rollbar
- `LOG_LEVEL` - —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- `LOG_FILE` - —Ñ–∞–π–ª –¥–ª—è –ª–æ–≥–æ–≤

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ email
- `EMAIL_SENDER` - –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
- `EMAIL_ADDRESS` - email –∞–¥—Ä–µ—Å
- `EMAIL_PASSWORD` - –ø–∞—Ä–æ–ª—å –æ—Ç email
- `SMTP_PORT` - –ø–æ—Ä—Ç SMTP —Å–µ—Ä–≤–µ—Ä–∞
- `SMTP_SERVER` - –∞–¥—Ä–µ—Å SMTP —Å–µ—Ä–≤–µ—Ä–∞

## –ó–∞–ø—É—Å–∫

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:
```bash
python main.py
```

2. –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
```bash
python main.py --dev
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
pytest
```

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

–ë–æ—Ç –≤–∫–ª—é—á–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Redis
- Rate limiting –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏
- –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏

## Development

### Configuration

```shell
sudo -u postgres pg_restore -d s95_dev deploy/backup.tar --no-privileges --no-owner -U postgres
```

### Tests

```shell
pip install -r tests/requirements.txt
pytest --cov-report=term-missing:skip-covered --cov=. tests/
```

For html report:
```shell
pytest --cov-report=html --cov=. tests/
```
